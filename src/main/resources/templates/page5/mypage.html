<!DOCTYPE html>
<html layout:decorate="~{layout/mainLayout}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>epimap</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
<style>
	@font-face {
	    font-family: 'GothicA1-Light';
	    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2205@1.0/GothicA1-Light.woff2') format('woff2');
	    font-weight: 300;
	    font-style: normal;
	}
	@font-face {
	    font-family: 'GothicA1-Bold';
	    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2205@1.0/GothicA1-Bold.woff2') format('woff2');
	    font-weight: 700;
	    font-style: normal;
	}
	body {
		font-family: 'GothicA1-Light', sans-serif;
	}
	.nickname {
		margin: 0 auto;
		margin-top: 149px;
		width: 85%;
		height: 120px;
		line-height: 80px;
		border-radius: 10px;
		box-shadow: 0 1px 20px #c4d0d566, 0 7px 10px #c5d0d640, 0 4 20px #96a7af66;
		background: linear-gradient(
			150deg,
			rgba(1, 57, 254, 0.4) 0%,
			rgba(16, 241, 255, 0.4) 100%
		), linear-gradient(0deg, rgba(0,98,255,1) 0%, rgba(0,98,255,1) 100%);
		text-align: left;
		color:white;
		font-family: 'GothicA1-bold', sans-serif;
		font-weight: 900;
		font-size:30px;
		border: 1px solid white;
	}
	.logoutbtn {
		margin-right: -82px;
	    margin-top: 75px;
	    width: 90px;
	    height: 30px;
	    line-height: 15px;
	    border: none;
	    background-color: #0062ff;
	    border-radius: 20px;
	    font-size: 18px;
	    font-family: 'GothicA1-bold', sans-serif;
	    float: left;
	    color: white;
	}
	.kakaobtn {
		margin-right:-172px;
	    margin-top: 75px;
	    width: 90px;
	    height: 30px;
	    line-height: 15px;
	    border: none;
	    background-color: #0062ff;
	    border-radius: 20px;
	    font-size: 15px;
	    font-family: 'GothicA1-bold', sans-serif;
	    float: left;
	    color: white;
	}
	.box1 {
		margin: 0 auto;
		margin-top: 15px;
		width: 100%;
		background-color: #ffffff;
		border-radius: 10px;
		box-shadow: 0px 1px 20px #c4d0d566, 0px 7px 10px #c5d0d640;
		
	}
	.scrabs {
		width: 412px;
		line-height: 90px;
		border-radius: 10px;
		color: #0062ff;
		font-size: 25px;
		font-family: 'GothicA1-bold', sans-serif;
		font-weight: 900;
		border: 1px solid white;
	}
	.line1 {
		margin-top: -20px;
		color: #E2E0E1;
	}
	.scrab-list {
		margin-top: -15px;
		height: 350px;
		overflow-y: auto;
	}
	.diag-list {
		margin-top: -15px;
		/* height: 350px;
		overflow-y: auto; */
		height: auto !important;
		overflow-y: auto;
	    padding-bottom: 80px;
	    box-shadow:  0px 2px 10px white;
	}
	.box2 {
		margin: 0 auto;
		margin-top: 15px;
		width: 100%;
		max-width: 100vw;
		background-color: #ffffff;
		border-radius: 10px;
		/* box-shadow: 0px 1px 20px #c4d0d566, 0px 7px 10px #c5d0d640; */
		box-shadow: 0px -2px 10px #c4d0d566, -2px 0px 10px #c4d0d566, 2px 0px 10px #c4d0d566 0px 2px 10px white;
		height: auto !important;
	}
	.self-diag {
		margin-top: 20px;
		width: 412px;
		line-height: 90px;
		border-radius: 10px;
		color: #0062ff;
		font-size: 25px;
		font-family: 'GothicA1-bold', sans-serif;
		font-weight: 900;
		border: 1px solid white;
	
	}
	.line2 {
		margin-top: -10px;
		color: #E2E0E1;
	}
	.innerbox1 {
		margin: 0 auto;
		margin-top: 25px;
		width: 85%;
		height: 100px;
		line-height: 100px;
		background-color: #ffffff;
		border-radius: 10px;
		box-shadow: 0px 1px 20px #c4d0d566, 0px 7px 10px #c5d0d640;
		border: 1px solid white;
		font-size: 20px;
		font-weight: bold;
		padding-left: 30px;
		
	}
	
	.innerbox2 {
		/* margin-left: 30px; */
		margin: 0 auto;
		margin-top: 25px;
		width: 85%;
		height: 100px;
		line-height: 70px;
		background-color: #ffffff;
		border-radius: 10px;
		box-shadow: 0px 1px 20px #c4d0d566, 0px 7px 10px #c5d0d640;
		border: 1px solid white;
		font-size: 20px;
		font-weight: bold;
		padding-left: 30px;
		line-height: 0.9;
	}
	.badge {
	    background: #ffffff;
	    color: gray;
	    border-radius: 12px;
	    font-size: 12px;
		margin-left: -5px;
		margin-bottom: 5px;
	}
	.newstitle {
	    font-weight: bold;
		font-size: 20px;
	    height: 30px;
	}
	.newstitle a {
	    display: inline-block;
	    width: 80%;         /* 부모 크기만큼 차지 */
	    white-space: nowrap; /* 줄 바꿈 금지 */
	    overflow: hidden;    /* 넘치는 텍스트 숨김 */
	    text-overflow: ellipsis; /* 말줄임표 표시 */
	    text-decoration: none;
	}
	.deleteScrab {
	    background: none;
	    border: none;
	    color: #0062ff;
	    font-size: 25px;
	   	float: right;
	   	margin-right: 30px;
	   	margin-top: -30px;
	   	cursor: pointer;
	}
	.day {
		margin-top: 20px;
		margin-left: -10px;
		margin-bottom: 20px;
		color: gray;
		font-size: 14px;
		width: 211px;
	}
	.result {
		margin-left: -10px;
	    margin-top: -5px;
	    font-size: 25px;
	    font-weight: bold;
	}
	
	.noresult {
		padding-bold: 65px;
		font-size: 6vw;
		color: gray;
	}
	
	.delete {
	    float: right;
	    margin-top: -65px;
	    background: none;
	    border: none;
	    font-size: 25px;
	    font-weight: bold;
	    cursor: pointer;
	    margin-right: 5px;
	}
	.diagpage {
		font-size: 20px;
		display: flex;
		justify-content: center;
		gap: 10px;
		color: #96A7AF;
	}
	.scrabpage {
		font-size: 20px;
		display: flex;
		justify-content: center;
		gap: 10px;
		color: #96A7AF;
	}
	.active {
		color: #0062ff;
		font-weight: bold;
		font-size: 1.1em;
	}
	.page-link {
    	border: none;
	}

	/* 페이징 버튼 텍스트 색상 (기본) */
	.pagination .page-item .page-link {
	    color: #0062FF;
	    font-size: 14px;
	    line-height: 1.2;
	}
	
	/* 페이징 버튼 텍스트 색상 (선택 상태) */
	.pagination .page-item.active .page-link {
	    background-color: #0062FF;
	    color: white;
	    border-radius: 5px;
	    font-size: 14px;
	    line-height: 1.2;
	}
</style>
</head>
<body class="d-flex flex-column min-vh-100">
	<div layout:fragment="content" class="content flex-grow-1">
		<div class="nickname">
		<!-- 카카오 로그인 유저 -->
	    <span th:if="${session.loginUser.kakao_nickname != null}">
	        [[${session.loginUser.kakao_nickname}]]([[${session.loginUser.nickname}]])님
	    </span>
	    <!--  일반 로그인 유저 -->
	    <span th:if="${session.loginUser.kakao_nickname == null}">
	        [[${session.loginUser.nickname}]]님
	         <button class="kakaobtn" style="margin-left: 80px;border: none; background: none;" onclick="connectKakao()">
       			 <img src="./kakao_login_small.png" alt="카카오 연결" style="width: 60px;" />
   			 </button>
	    </span>
		<button class="logoutbtn" type="button" value="로그아웃" onclick="logoutAll()">로그아웃</button>
		<span th:if="${session.loginUser.admin}"
		 style="float: right; margin-right: 10px;">
			<button class="feedbacksbtn btn btn-secondary"
			 onclick="location.href='/feedbacks'">Feedback 목록</button>
		</span>
		</div>
		<div class="box1">
			<div class="scrabs">
				<!-- 카카오 로그인 유저 -->
				<span th:if="${session.loginUser.kakao_nickname != null}" style="margin-left: 30px;">
		        [[${session.loginUser.kakao_nickname}]]님의 스크랩
		   		 </span>
			    <!--  일반 로그인 유저 -->
			    <span th:if="${session.loginUser.kakao_nickname == null}" style="margin-left: 30px;">
			        [[${session.loginUser.nickname}]]님의 스크랩
			    </span>
		    </div>
			<hr class="line1">
			<div class="scrab-list"></div>
		</div>
		<div class="box2">
			<div class="self-diag">
				<!-- 카카오 로그인 유저 -->
				<span th:if="${session.loginUser.kakao_nickname != null}" style="margin-left: 30px;">
				[[${session.loginUser.kakao_nickname}]]님의 자가진단 결과
		   		 </span>
			    <!--  일반 로그인 유저 -->
			    <span th:if="${session.loginUser.kakao_nickname == null}" style="margin-left: 30px;">
			        [[${session.loginUser.nickname}]]님의 자가진단 결과
			    </span>
			</div>
			<hr class="line2">
			<div class="diag-list"></div>
		</div>
			<script type="text/javascript">
				scrabsdata();
				//스크랩 데이터 불러오기
				function scrabsdata(page = 1) {
					$.ajax({
						type:"get",
						dataType:"json",
						data:{pageNum : page},
						url:"/scrablist",
						success:function(res) {
							if (res.status === "unauthorized") {
					                alert("로그인이 필요합니다.");
					                location.href = "/login";
					                return;
					        }
							
							const list = res.scrabs;
							let s = "";
							if (list.length === 0 && page > 1) {
								scrabsdata(page - 1);
								currentScrabPage = page - 1;
						        return;
						      }

							currentScrabPage = page; // 현재 페이지 기억
							if(list.length == 0) {
								$(".content").css("overflow-y", "hidden");
								s += `<div class="innerbox1" style="line-height:100px;">
									<div class="noresult">스크랩된 뉴스가 없습니다.</div>
								</div>
								`;
								  $(".scrab-list").html(s);
								  $(".scrab-list").css("height", "200px","overflow-y", "hidden"); // 공간 확보
							} else if(list.length == 1 ) {
								$(".content").css("overflow-y", "hidden");
								$.each(list, function(i,item){
									s += `
										<div class="innerbox1">
										<div class="newstitle">
											<a href="${item.url}" style="color:#324F5E" target="_blank">${item.title}</a>
										</div>
											<i class="bi bi-bookmark-heart-fill deleteScrab" data-id="${item.scrabs_id}"></i>
									</div>`;
								});
								$(".scrab-list").html(s);
								$(".box1").css("height","300px");
								/* $(".scrab-list").css("height", "300px;"); */
								$(".scrab-list").attr("style", "height: 300px !important; overflow-y: hidden;");
							} else {
								$.each(list, function(i,item){
									s += `
										<div class="innerbox1">
										<div class="newstitle">
											<a href="${item.url}" style="color:#324F5E" target="_blank">${item.title}</a>
										</div>
											<i class="bi bi-bookmark-heart-fill deleteScrab" data-id="${item.scrabs_id}"></i>
									</div>`;
								});
								
							}
								/* s += `<br><div class="pagination"></div>`;
							$(".scrab-list").html(s);
							let p = "";
							for(let i = 1; i <= res.totalPage; i++) {
								p += `<a href="" class="page-link1 ${i === page ? 'active' : ''}" data-page="${i}">${i}</a>`;
							}
							$(".pagination").html(p); */
							s += `<br><nav><ul class="pagination scrab-pagination justify-content-center"></ul></nav>`;
							$(".scrab-list").html(s);
							//1개 이하 일 때 페이징버튼 숨긱
							if (res.totalPage == 0) {
								  $(".scrab-pagination").parent("nav").hide();
								} else {
								  $(".scrab-pagination").parent("nav").show();
								}
							let p = "";
							if (page > 1) {
								  p += `
								    <li class="page-item">
								      <a class="page-link" href="#" data-page="${page - 1}">&laquo;이전</a>
								    </li>`;
								} else {
								  p += `
								    <li class="page-item disabled">
								      <a class="page-link" href="#" tabindex="-1" aria-disabled="true">&laquo;이전</a>
								    </li>`;
								}

								// 페이지 번호들
								for (let i = 1; i <= res.totalPage; i++) {
								  p += `
								    <li class="page-item ${i === page ? 'active' : ''}">
								      <a class="page-link" href="#" data-page="${i}">${i}</a>
								    </li>`;
								}

								// 다음 버튼
								if (page < res.totalPage) {
								  p += `
								    <li class="page-item">
								      <a class="page-link" href="#" data-page="${page + 1}">다음&raquo;</a>
								    </li>`;
								} else {
								  p += `
								    <li class="page-item disabled">
								      <a class="page-link" href="#" tabindex="-1" aria-disabled="true">다음&raquo;</a>
								    </li>`;
								}
								$(".scrab-pagination").html(p);
						}
					});	
				}
				//스크랩 페이지 이동
				let currentScrabPage = 1;
				$(document).on("click", ".scrab-pagination .page-link", function(e) {
				    e.preventDefault(); // 🔴 새로고침 막기
				    currentScrabPage = $(this).data("page");
				    scrabsdata(currentScrabPage);
				});
				//스크랩 데이터 삭제 이벤트
				$(document).on("click", ".deleteScrab", function() {
					 const id = $(this).data("id");

					    $.ajax({
					        url: "/deletescrab",
					        type: "POST",
					        data: { scrabs_id: id },
					        success: function(res) {
					            if (res.status === "success") {
					                scrabsdata(currentScrabPage);
					            } else {
					                alert("삭제 실패. 다시 시도해주세요.");
					            }
					        }
					    });
					});
				
				diagdata();
				//자가진단 데이터 불러오기
				function diagdata(page = 1) {
					$.ajax({
						type:"post",
						dataType:"json",
						data:{page : page},
						url:"/selfdiag",
						success:function(res) {
							let s= "";
							let list = res.list;
							
							if (list.length === 0 && page > 1) {
						        diagdata(page - 1);
						        currentDiagPage = page - 1;
						        return;
						      }

						      currentDiagPage = page; // 현재 페이지 기억

							if(list.length == 0) {
								s += `
								<div class="innerbox2" style="line-height:100px;">
									<div class="noresult">자가진단 이력이 없습니다.</div>
								</div>
								`;
								$(".diag-list").html(s);
								$(".diag-list").css("height","250px","overflow-y", "hidden");
								return;
							} else if(list.length == 1) {
								$.each(list, function(idx, d) {
									s+= `
									<div class="innerbox2">
										<div class="day">진단일자 : ${d.writeday}</div>
										<div class="result">${d.disease}</div>
											<i class="bi bi-x delete" myresult="${d.myresult_id}"></i>
									</div>
									`;
								});
								  s += `<br><nav><ul class="pagination diag-pagination justify-content-center"></ul></nav>`;
								$(".diag-list").html(s);
								$(".diag-list").css("height", "auto"); // 공간 확보
							} else {
							$.each(list, function(idx, d) {
								s+= `
								<div class="innerbox2">
									<div class="day">진단일자 : ${d.writeday}</div>
									<div class="result">${d.disease}</div>
										<i class="bi bi-x delete" myresult="${d.myresult_id}"></i>
								</div>
								`;
							});
								s += `<br><nav><ul class="pagination diag-pagination justify-content-center"></ul></nav>`;
							$(".diag-list").html(s);
							$(".diag-list").css("height", "auto"); 
							}
							
							let p = "";
							if (page > 1) {
								  p += `
								    <li class="page-item">
								      <a class="page-link" href="#" data-page="${page - 1}">&laquo;이전</a>
								    </li>`;
								} else {
								  p += `
								    <li class="page-item disabled">
								      <a class="page-link" href="#" tabindex="-1" aria-disabled="true">&laquo;이전</a>
								    </li>`;
								}

								// 페이지 번호들
								for (let i = 1; i <= res.totalPages; i++) {
								  p += `
								    <li class="page-item ${i === page ? 'active' : ''}">
								      <a class="page-link" href="#" data-page="${i}">${i}</a>
								    </li>`;
								}

								// 다음 버튼
								if (page < res.totalPages) {
								  p += `
								    <li class="page-item">
								      <a class="page-link" href="#" data-page="${page + 1}">다음&raquo;</a>
								    </li>`;
								} else {
								  p += `
								    <li class="page-item disabled">
								      <a class="page-link" href="#" tabindex="-1" aria-disabled="true">다음&raquo;</a>
								    </li>`;
								}

								$(".diag-pagination").html(p);
						}

					});
				}
				//자가진단 페이지 이동
				let currentDiagPage = 1;
				$(document).on("click", ".diag-pagination .page-link", function(e) {
				    e.preventDefault(); // 🔴 새로고침 막기
				    currentDiagPage = $(this).data("page");
				    diagdata(currentDiagPage);
				});
				//자가진단 데이터 삭제 이벤트
				$(document).on("click", ".delete", function() {
					let myresult_id = $(this).attr("myresult");
					console.log(myresult_id);
					$.ajax({
						type:"get",
						dataType:"text",
						data:{"myresult_id" : myresult_id},
						url:"/deleteMyResult",
						success:function() {
							diagdata(currentDiagPage);
						}
					});
				});
			/* 	function adjustBoxHeights() {
					  const vh = window.innerHeight;
					  const nicknameHeight = $(".nickname").outerHeight(true);
					  const footerHeight = $("footer").outerHeight(true) || 60;

					  const availableHeight = vh - nicknameHeight - footerHeight;

					  const boxHeight = availableHeight / 2;

					  $(".box1, .box2").css("height", boxHeight + "px");
					  $(".scrab-list, .diag-list").css("height", (boxHeight - 100) + "px"); // -100은 제목+hr+패딩 고려
					}

					// 실행 시점
					$(document).ready(adjustBoxHeights);
					$(window).on("resize", adjustBoxHeights); */
			</script>
			<script>
				Kakao.init('55844f9373522ab837bcc9a12eaff759');
				
				function connectKakao() {
					  $.post("/isKakaoConnected", function(isConnected) {
					    if (isConnected) {
					      alert("이미 연결된 계정입니다.");
					      return;
					    }

					    Kakao.Auth.login({
					      scope: 'profile_nickname',
					      success: function() {
					        Kakao.API.request({
					          url: '/v2/user/me',
					          success: function(res) {
					            const kakao_id = res.id;
					            const kakao_nickname = res.properties.nickname;

					            $.post("/connectKakao", {
					              kakao_id,
					              kakao_nickname
					            }, function(result) {
					              if (result === "ok") {
					                alert("카카오 계정 연결 완료!");
					                location.href = "/mypage";
					              } else if (result === "already_connected") {
					                alert("다른 계정에 이미 연결된 카카오계정입니다.");
					              } else {
					                alert("연결 실패");
					              }
					            });
					          }
					        });
					      }
					    });
					  });
					}
				function logoutAll() {
					  Kakao.Auth.logout(() => {
					    location.href = "/logout"; // 서버 로그아웃
					  });
					}
			</script>
			</div>
		</div>
</body>
</html>     