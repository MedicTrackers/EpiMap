<!DOCTYPE html>
<html layout:decorate="~{layout/mainLayout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>medicalmap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">
    <!-- map api ê°ì ë°œê¸‰ë°›ì€ Client ID ê°’ ë„£ê¸° -->
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=yg9kt0fwzl&language=en"></script>

<style>
    @font-face {
        font-family: 'GothicA1-Light';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2205@1.0/GothicA1-Light.woff2') format('woff2');
        font-weight: 300;
        font-style: normal;
    }

    @font-face {
        font-family: 'GothicA1-Bold';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2205@1.0/GothicA1-Bold.woff2') format('woff2');
        font-weight: 700;
        font-style: normal;
    }

    body {
        font-family: 'GothicA1-Light', sans-serif;
    }

    /*ì§€ë„ì˜ì—­ css*/
    .map-container {
        width: 100vw;
        height:90vh;
        margin: 0 auto;
        z-index: 1;
    }

    /*ë‚´ìœ„ì¹˜ ì•„ì´ì½˜ css*/
    .myLocationBtn_icon {
        background-color: #ffffff;
        border: 0px solid transparent;
        position: absolute;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        z-index: 8;
        right: 9px;
        top: 35vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /*ë‚´ìœ„ì¹˜ì—ì„œ ê²€ìƒ‰ ë²„íŠ¼ css*/
    .gpsbtb {
        position: absolute;
        top: 142px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;

        background-color: #ffffff;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        color: #0062ff;
        border: none;

        display: flex;
        align-items: center;
        gap: 6px;
        /*ë²„íŠ¼ ì¤„ë°”ê¿ˆ ë°©ì§€*/
        white-space: nowrap;
    }


    /*ë°”í…€ì‹œí‹° íŠ¸ë¦¬ê±° í„°ì¹˜ê°ì§€ìš© css*/
    .up_sensor {
        z-index: 99;
        position: fixed;
        background: transparent;
        width: 100%;
        bottom: 0;
        left: 0;
        height: 10%;
        transition-duration: 1s;
    }

    /*ë°”í…€ì‹œíŠ¸ ë³¸ì²´CSS*/
    .bottom_sheet {
        z-index: 10;
        display: flex;
        position: fixed;
        bottom: 0;
        width: 100vw;
        height: 50%;
        border-top-left-radius: 30px;
        border-top-right-radius: 30px;
        background-color: #FDFDFD;
        overflow-y: auto;
        flex-direction: column;
        align-items: center;
        transition-duration: 0.5s;
    }

    /*ë°”í…€ì‹œíŠ¸ (bar)ë°” ë¶€ë¶„*/
    .bottom_sheet_handle_wrap {
        z-index: 99;
        background: linear-gradient(to bottom,
        rgba(255, 255, 255, 1) 20%,
        rgba(255, 255, 255, 0.75) 35%,
        rgba(255, 255, 255, 0.5) 60%,
        rgba(255, 255, 255, 0.25) 85%,
        rgba(255, 255, 255, 0) 100%);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        width: 80vw;
        height: 40px;
        margin-bottom: 10px;
        position: fixed;
    }
    .bottom_sheet_handle {
        width: 72px;
        height: 4px;
        background-color: #e2e0e1;
        border-radius: 100px;
        margin-top: 15px;
    }

    /*ë³‘ì› ë¦¬ìŠ¤íŠ¸ css*/
    .medical-scrap {
        width: 100%;
        height: 100%;
        position: relative;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .medical-list-container:first-child {
        margin-top: 12px; /* âœ… ì§ì ‘ ì—¬ìœ ë¥¼ ì¤˜ì„œ ìœ„ìª½ ê·¸ë¦¼ìê°€ ë³´ì´ê²Œ */
    }

    /*ë³‘ì›ë¦¬ìŠ¤íŠ¸ íƒ€ì´í‹€*/
    .medical-title {
        font-family: 'GothicA1-Bold';
        font-size: 24px;
        width: 100vw;
        margin-top: 40px;
        margin-bottom: 20px;
        margin-left: 30px;
    }

    /*ë³‘ì›ë¦¬ìŠ¤íŠ¸ ë¼ì¸*/
    .line{
        width: 100vw;
        height: 1px;
        background-color: #E2E0E1;
        top: 0;
        left: 0;
        margin-bottom: 10px;
    }

    /*ë³‘ì›ë¦¬ìŠ¤íŠ¸ ìŠ¤í¬ë¡¤ì˜ì—­ css*/
    .medical-scroll-box {
        overflow-y: auto;
        flex: 1;
        padding-top: 10px;
        padding-bottom: 40px;
    }

    /*ë³‘ì›ë¦¬ìŠ¤íŠ¸ ë°•ìŠ¤ì˜ì—­ css*/
    .medical-box {
        display: flex;
        flex-direction: column;
        align-items: center; /*ì¹´ë“œ ê°€ìš´ë° ì •ë ¬ */
        overflow-x: auto;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    /*ë³‘ì›ë¦¬ìŠ¤íŠ¸ css */
    .medical-list-container {
        width: 90vw;
        height: 161px;
        border-radius: 10px;
        box-shadow: 0px 1px 20px #c4d0d5db;
        position: relative;
        flex-shrink: 0;
        margin-bottom: 20px;
    }

    /*ë³‘ì›ì´ë¦„ css */
    .medicallist-header .medical-name {
        position: absolute;
        top: 15px;
        left: 20px;
        font-weight: 700;
        color: #0062ff;
        font-size: 23px;
        letter-spacing: 0;
        line-height: normal;

        /* ë§ì¤„ì„ ì²˜ë¦¬ */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /*ë³‘ì› ì „í™” ë²„íŠ¼ css*/
    .tel-button{
        position: relative;
        width: 52px;
        height: 59px;
        top: 80px;
        left: 70vw;
        background-color: #ffffff;
        border-radius: 32.5px;
        border: 2px solid;
        border-color: #96A7AF;
    }
    .telicon{
        position: relative;
        color: #96A7AF;
        font-size: 25px;
        left: 12px;
        top:16px;
    }

    /*ì‘ê¸‰ì‹¤ ê°€ìš©ì—¬ë¶€*/
    .emergency-status {
        position: absolute;
        width: 170px;
        height: 33px;
        top: 63px;
        left: 18px;
        background-color: #c91c1c;
        border-radius: 32.5px;
        /* âœ… Flexë¡œ ê°€ìš´ë° ì •ë ¬ */
        display: flex;
        align-items: center;   /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
    }
    .status-label {
        font-weight: 600;
        color: #ffffff;
        font-size: 17px;
        text-align: center;
        line-height: normal;
    }
    .status-value {
        font-weight: 600;
        color: #ffffff;
        font-size: 17px;
        text-align: center;
        line-height: normal;
    }

    /*ë³‘ì› ë²ˆí˜¸ css*/
    .medical-phone {
        position: absolute;
        top: 110px;
        left: 20px;
        font-weight: 600;
        color: #0062ff;
        font-size: 20px;
        letter-spacing: 0;
        line-height: normal;
    }

    /*ë³‘ì›ë¦¬ìŠ¤íŠ¸ í´ë¦­ì‹œ ë³€ê²½ css*/
    .medical-box .select {
        position: relative;
        width: 90vw;
        height: 161px;
        border-radius: 10px;
        box-shadow: 0 1px 20px #c4d0d566, 0 7px 10px #c5d0d640, 0 4px 20px #96a7af66;
        background: linear-gradient(
                150deg,
                rgba(1, 57, 254, 0.4) 0%,
                rgba(16, 241, 255, 0.4) 100%
        ), linear-gradient(0deg, rgba(0,98,255,1) 0%, rgba(0,98,255,1) 100%);
    }

    /*ì „í™”ê¸° ì•„ì´ì½˜ ìƒ‰ìƒë³€ê²½*/
    .medical-list-container.select .telicon {
        color: #c91c1c !important; /* ì„ íƒëœ ë³‘ì›ì˜ ì „í™” ì•„ì´ì½˜ì€ ë¹¨ê°„ìƒ‰ */
    }

    /*í°íŠ¸ìƒ‰ìƒ ë³€ê²½*/
    .medical-box .selectfont {

        color: #ffffff;
    }
    </style>
</head>
<body>
<div layout:fragment="content" >
    <!--ì§€ë„ì˜ì—­-->
    <div id="map" class="map-container"></div>
    <!--ë‚´ ìœ„ì¹˜ ì•„ì´ì½˜-->
    <button id="myLocationBtn" class="myLocationBtn_icon">
        <img src="/images/catch_icon.png" width="24" height="24" alt="ë‚´ìœ„ì¹˜ì•„ì´ì½˜">
    </button>
    <!-- ë‚´ ìœ„ì¹˜ì—ì„œ ê²€ìƒ‰ë²„íŠ¼ -->
    <button id="searchByMapCenterBtn"  class="gpsbtb">
        <i class="bi bi-arrow-clockwise" style="font-size: 20px;"></i>í˜„ ìœ„ì¹˜ì—ì„œ ê²€ìƒ‰
    </button>

    <!-- ë°”í…€ì‹œíŠ¸ íŠ¸ë¦¬ê±° ì„¼ì„œ (í„°ì¹˜ ê°ì§€ìš©) -->
    <div class="up_sensor"></div>

    <!-- ë°”í…€ì‹œíŠ¸ ë³¸ì²´ -->
    <div id="bottomSheet" class="bottom_sheet">
        <!-- ë°”í…€ì‹œíŠ¸ í•¸ë“¤ -->
        <div class="bottom_sheet_handle_wrap">
            <div class="bottom_sheet_handle"></div>
        </div>
        <!--ë³‘ì› ë¦¬ìŠ¤íŠ¸-->
        <div class="medical-scrap">
            <!--ë³‘ì›ë¦¬ìŠ¤íŠ¸ íƒ€ì´í‹€-->
            <div class="medical-title">ì‘ê¸‰ì‹¤ ë¹ ë¥¸ ì—°ê²°</div>
            <div class="line"></div>
            <!--ë³‘ì› ë¦¬ìŠ¤íŠ¸ ì„¸ë¡œí˜•-->
            <div class="medical-scroll-box">
                <div id="medical-list" class="medical-box">
                    <!--ë³‘ì›ë¦¬ìŠ¤íŠ¸ ì˜ì—­-->
                </div>
            </div>
        </div>
    </div>

<script>

    let lat,lon,map;
    let activeInfoWindow = null;  // í˜„ì¬ ì—´ë ¤ìˆëŠ” ì •ë³´ì°½ ì¶”ì 
    let hospitalMarkers = [];
    let myLocationMarker = null;
    let myInfoWindow = null;

    // ë‚´ìœ„ì¹˜ ê²€ìƒ‰ ë²„íŠ¼ ì œì–´ í•¨ìˆ˜
    function hideSearchBtn() {
        $("#searchByMapCenterBtn").fadeOut(200); // ë¶€ë“œëŸ½ê²Œ ìˆ¨ê¹€
    }

    function showSearchBtn() {
        $("#searchByMapCenterBtn").fadeIn(200); // ë¶€ë“œëŸ½ê²Œ ë³´ì„
    }

    function clearHospitalMarkers() {
        hospitalMarkers.forEach(marker => marker.setMap(null));
        hospitalMarkers = [];
    }

    // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹ ì‚¬ìš©)
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }
        const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    /*ë³‘ì›ë¦¬ìŠ¤íŠ¸ í´ë¦­ì‹œ ìƒ‰ìƒë³€í™” ë° ìŠ¤í¬ë¡¤ ì˜ì—­ ë¶€ë“œëŸ½ê²Œ ì„¤ì •*/
    function highlightCard(idx) {
        $(".medical-list-container").removeClass("select");
        $(".medical-list-container .medical-phone, .medical-list-container .medical-name").removeClass("selectfont");

        let $target = $(`.medical-list-container[data-idx="${idx}"]`);
        $target.addClass("select");
        $target.find(".medical-phone, .medical-name").addClass("selectfont");

        $("#medical-list").prepend($target);

        // âœ… ìŠ¤í¬ë¡¤ ì˜ì—­ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ìš”ì†Œë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
        $target[0].scrollIntoView({
            behavior: 'smooth',
            block: 'start' // 'center', 'end'ë„ ê°€ëŠ¥
        });
    }

    /*ì§€ë„ ì´ˆê¸°í™”*/
    navigator.geolocation.getCurrentPosition((position) => {
        console.log(">>>>"+"getCurrentPosition");
        lat = position.coords.latitude;
        lon = position.coords.longitude;

        let currentLocation = new naver.maps.LatLng(lat, lon);

        let mapOptions = {
            center: currentLocation,
            zoom: 15,
            zoomControl: true,
            zoomControlOptions: {
                style: naver.maps.ZoomControlStyle.SMALL,
                position: naver.maps.Position.RIGHT_CENTER // +,- ì§€ë„ ìœ„ì¹˜ ë³€ê²½
            }
        };

        map = new naver.maps.Map('map', mapOptions);


        //ì§€ë„ í´ë¦­ì‹œ ì •ë³´ì°½ ë‹«ê¸°
        naver.maps.Event.addListener(map, "click", () => {
            if (activeInfoWindow) {
                activeInfoWindow.close();
                activeInfoWindow = null;
            }
        });

        // âœ… ì§€ë„ ì´ë™ ì‹œ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
        naver.maps.Event.addListener(map, "dragend", function () {
            showSearchBtn();
        });


        // í˜„ì¬ ìœ„ì¹˜ì— ë§ˆì»¤ ì°ê¸°
        let marker = new naver.maps.Marker({
            position: currentLocation,
            map: map,
            icon: {
                content: `
          <div style="
            width: 20px;
            height: 20px;
            border: 6px solid rgb(0,98,255);
            background-color: #ffffff;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
          "></div>
        `,
                size: new naver.maps.Size(20, 20),
                anchor: new naver.maps.Point(10, 10)
            },
            title: 'ë‚´ ìœ„ì¹˜'
        });

        // ë‚´ìœ„ì¹˜ í´ë¦­í•˜ë©´ ì •ë³´ì°½ êµ¬í˜„
        let infoWindow = new naver.maps.InfoWindow({
            content: '<div style="padding:5px;">ğŸ“ í˜„ì¬ ìœ„ì¹˜ì…ë‹ˆë‹¤.</div>'
        });

        naver.maps.Event.addListener(marker, "click", function () {
            infoWindow.open(map, marker);
        });

        //ë³‘ì›ë°ì´í„° í˜¸ì¶œ
        medical();

    }, (error) => {
        alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ìœ„ì¹˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        console.error(error);
    });

    /*ë‚´ìœ„ì¹˜ ì•„ì´ì½˜ í´ë¦­ì‹œ ìŠ¤í¬ë¦½íŠ¸*/
    $("#myLocationBtn").on("click", function () {

        navigator.geolocation.getCurrentPosition(
            function (position) {
                lat = position.coords.latitude;
                lon = position.coords.longitude;

                let currentPosition = new naver.maps.LatLng(lat, lon);
                map.setCenter(currentPosition);

                medical(); // ë‹¤ì‹œ ë‚´ ìœ„ì¹˜ ê¸°ì¤€ ë³‘ì› ê²€ìƒ‰

                // ë§ˆì»¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ê³ , ìˆìœ¼ë©´ ìœ„ì¹˜ë§Œ ì—…ë°ì´íŠ¸
                if (!myLocationMarker) {

                    myLocationMarker = new naver.maps.Marker({
                        position: currentPosition,
                        map: map,
                        icon: {
                            content: `
                                       <div style="width: 20px; height: 20px;border: 6px solid rgb(0,98,255);background-color: #ffffff;
                                            border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.3);">
                                        </div>
                                         `,
                            size: new naver.maps.Size(20, 20),
                            anchor: new naver.maps.Point(10, 10)
                        },
                        title: "ë‚´ ìœ„ì¹˜"
                    });

                    myInfoWindow = new naver.maps.InfoWindow({
                        content: '<div style="padding:5px;">ğŸ“ í˜„ì¬ ìœ„ì¹˜ì…ë‹ˆë‹¤.</div>'
                    });

                    naver.maps.Event.addListener(myLocationMarker, "click", function () {
                        if (activeInfoWindow) activeInfoWindow.close();
                        activeInfoWindow = myInfoWindow;
                        myInfoWindow.open(map, myLocationMarker);
                    });
                }else{
                    myLocationMarker.setPosition(currentPosition);
                }
                // âœ… ë‚´ ìœ„ì¹˜ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œë„ ì •ë³´ì°½ ì—´ê¸°
                if (activeInfoWindow) activeInfoWindow.close();
                activeInfoWindow = myInfoWindow;
                myInfoWindow.open(map, myLocationMarker);

                medical(); // ë³‘ì› ëª©ë¡ ë‹¤ì‹œ í˜¸ì¶œ

            },
            function (error) {
                alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                console.error(error);
            }
        );
    });

    function clearHospitalMarkers() {
        hospitalMarkers.forEach(marker => marker.setMap(null));
        hospitalMarkers = [];
    }

    // ë‚´ìœ„ì¹˜ ê²€ìƒ‰ ë²„íŠ¼ ìŠ¤í¬ë¦½íŠ¸
    $("#searchByMapCenterBtn").on("click", function () {
        if (!map) {
            console.warn("ì§€ë„ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        const center = map.getCenter(); // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬
        lat = center.lat();
        lon = center.lng();
        console.log(" í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ê²€ìƒ‰:", lat, lon);
        hideSearchBtn();
        medical(); // ì´ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë³‘ì› ë‹¤ì‹œ ê²€ìƒ‰
    });

    /*ë°”í…€ì‹œíŠ¸ ìŠ¤í¬ë¦½íŠ¸*/
    let bottomSheet = document.querySelector('.bottom_sheet');
    let startY = 0;
    let currentY = 0;
    let deltaY = 0;
    let currentState = 'middle'; // ìƒíƒœ: 'min' | 'middle' | 'max'

    // ì´ˆê¸° ë†’ì´ ì„¤ì •
    bottomSheet.style.height = '48%';

    // í„°ì¹˜ ì‹œì‘
    bottomSheet.addEventListener('touchstart', (e) => {
        startY = e.touches[0].pageY;
    });

    // í„°ì¹˜ ì¢…ë£Œ ì‹œ ë°©í–¥ íŒë³„
    bottomSheet.addEventListener('touchend', (e) => {
        deltaY = e.changedTouches[0].pageY - startY;

        if (deltaY < -30) {
            // ìœ„ë¡œ ìŠ¤ì™€ì´í”„ (ì˜¬ë¦¼)
            if (currentState === 'middle') {
                bottomSheet.style.height = '85%';
                currentState = 'max';
            } else if (currentState === 'min') {
                bottomSheet.style.height = '48%';
                currentState = 'middle';
            }
        } else if (deltaY > 30 && bottomSheet.scrollTop === 0) {
            // ì•„ë˜ë¡œ ìŠ¤ì™€ì´í”„ (ë‚´ë¦¼)
            if (currentState === 'middle') {
                bottomSheet.style.height = '20%';
                currentState = 'min';
            } else if (currentState === 'max') {
                bottomSheet.style.height = '48%';
                currentState = 'middle';
            }
        }
    });

    /*ë³‘ì› ê³µê³µë°ì´í„° api í˜¸ì¶œ*/
    function medical() {

        clearHospitalMarkers();              // ğŸ”¹ ê¸°ì¡´ ë§ˆì»¤ ì œê±°
        $("#medical-list").empty();      // ğŸ”¹ ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì œê±°

        $.ajax({
            url: 'https://apis.data.go.kr/B552657/ErmctInfoInqireService/getEgytBassInfoInqire',
            type: 'GET',
            data: {
                serviceKey: '17Ds6cxIqo9+znsM81nIgrGHeWGzUlZBHQ9s9GSWEFqc1McvZaH2ovzWYKxVdi8AopGjXaYCZWcLCX6VcqWd/Q==',  // API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
                pageNo: 1,
                numOfRows: 500
            },
            dataType: 'xml',  // XML ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ë°˜í™˜ë°›ê¸°
            success: function(response) {
                // XML ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜
                let jsonResponse = xmlToJson(response);

                let items = jsonResponse.response.body.items.item;

                if (!Array.isArray(items)) {
                    items = [items];
                }

                let filtered = [];

                // ë³‘ì› ê±°ë¦¬ ê³„ì‚° ë° í•„í„°ë§
                $.each(items, function(idx, info) {
                    let hospLat = parseFloat(info.wgs84Lat?.['#text']);
                    let hospLon = parseFloat(info.wgs84Lon?.['#text']);
                    if (isNaN(hospLat) || isNaN(hospLon)) return;

                    let distance = getDistanceFromLatLonInKm(lat, lon, hospLat, hospLon);

                    if (distance <= 5) { // ë°˜ê²½ 5km ì´ë‚´ë§Œ
                        info.distance = distance;
                        info.hospLat = hospLat;
                        info.hospLon = hospLon;
                        filtered.push(info);
                    }
                });

                //ë³‘ì› ê¸€ì ê¸¸ì–´ì ¸ì„œ ê¸€ì ì œê±° ìŠ¤í¬ë¦½íŠ¸ ì ìš©
                function cleanHospitalName(name) {
                    return name
                        .replace(/(ì¬ë‹¨ë²•ì¸|ì˜ë£Œë²•ì¸|ì‚¬íšŒë³µì§€ë²•ì¸|ì˜ë£Œì¬ë‹¨|ë³µì§€ì¬ë‹¨|ì¬ë‹¨|ë¶€ì†|ì•„ì‚°ì‚¬íšŒ|í•™êµë²•ì¸ê³ ë ¤ì¤‘ì•™í•™ì›|ì˜ê³¼ëŒ€í•™ë¶€ì†ë³‘ì›|í•™êµë²•ì¸ê°€í†¨ë¦­í•™ì›ê°€í†¨ë¦­ëŒ€í•™êµ|ì—°ì„¸ëŒ€í•™êµì˜ê³¼ëŒ€í•™)/g, '')
                        .replace(/[\(\)]/g, '') // ê´„í˜¸ ì œê±°
                        .trim();
                }

                // ê±°ë¦¬ìˆœ ì •ë ¬
                filtered.sort((a, b) => a.distance - b.distance);

                // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                $("#medical-list").empty();

                // ë§ˆì»¤ ë° ì¹´ë“œ ì¶œë ¥
                $.each(filtered, function(idx, info) {

                    if (!info.hvec?.['#text']) return; //ì‘ê¸‰ì‹¤ ê°€ìš©ì—¬ë¶€ ì—†ìœ¼ë©´ ë§ˆì»¤ ìƒì„±ì•ˆí•¨

                    let hospitalPosition = new naver.maps.LatLng(info.hospLat, info.hospLon);

                    let hospitalMarker = new naver.maps.Marker({
                        position: hospitalPosition,
                        map: map,
                        icon: {
                            url: '/images/ico_pin.png',
                            size: new naver.maps.Size(25, 34),
                            scaledSize: new naver.maps.Size(25, 34),
                            origin: new naver.maps.Point(0, 0),
                            anchor: new naver.maps.Point(12, 34)
                        },
                        title: info.dutyName['#text']
                    });

                    hospitalMarkers.push(hospitalMarker);  // âœ… ì €ì¥

                    let infoWindow = new naver.maps.InfoWindow({
                        content: `<div style="padding:5px; font-size:13px;">ğŸ¥ ${info.dutyName['#text']}</div>`
                    });

                    naver.maps.Event.addListener(hospitalMarker, "click", function () {
                        infoWindow.open(map, hospitalMarker);

                        map.setCenter(hospitalPosition);
                        highlightCard(idx);
                    });

                    $(document).on("click", ".medical-list-container", function () {
                        const idx = $(this).data("idx");
                        const selected = filtered[idx];
                        const hospitalPosition = new naver.maps.LatLng(selected.hospLat, selected.hospLon);

                        map.setCenter(hospitalPosition);
                        highlightCard(idx);

                        // ê¸°ì¡´ ì •ë³´ì°½ ë‹«ê¸°
                        if (activeInfoWindow) activeInfoWindow.close();

                        const infoWindow = new naver.maps.InfoWindow({
                            content: `<div style="padding:5px; font-size:13px;">ğŸ¥ ${selected.dutyName['#text']}</div>`
                        });

                        infoWindow.open(map, new naver.maps.Marker({
                            position: hospitalPosition,
                            map: map,
                            icon: {
                                url: '/images/ico_pin.png',
                                size: new naver.maps.Size(25, 34),
                                scaledSize: new naver.maps.Size(25, 34),
                                origin: new naver.maps.Point(0, 0),
                                anchor: new naver.maps.Point(12, 34)
                            }
                        }));
                        // âœ… í˜„ì¬ ì •ë³´ì°½ ì €ì¥
                        activeInfoWindow = infoWindow;
                    });

                    let cleanedName = cleanHospitalName(info.dutyName['#text']);

                    if (!info.hvec?.['#text']) return; // ì‘ê¸‰ì‹¤ ê°€ìš©ì—¬ë¶€ ê°’ ì—†ìœ¼ë©´ skip

                    $("#medical-list").append(`

                        <div class="medical-list-container" data-idx="${idx}">
                            <div class="medicallist-header">
                                <span class="medical-name">${cleanedName}</span>
                                <div class="tel-button">
                                    <a href="tel:${info.dutyTel1?.['#text']}">
                                        <i class="bi bi-telephone-fill telicon"></i>
                                    </a>
                            </div>
                            </div>
                            <div class="medicallist-body">
                                <p class="medical-phone">
                                    ë³‘ì› ë²ˆí˜¸: <span class="normal-text">${info.dutyTel1?.['#text'] || "ì •ë³´ ì—†ìŒ"}</span>
                                </p>
                                <div class="emergency-status">
                                    <span class="status-label">ì‘ê¸‰ì‹¤ ê°€ìš©ì—¬ë¶€:&nbsp;</span>
                                    <span class="status-value">${info.hvec?.['#text'] || "-"}</span>
                                </div>
                            </div>
                        </div>
                    `);
                });
            },
            error: function(xhr, status, error) {
                console.error("API í˜¸ì¶œ ì˜¤ë¥˜: " + status + ", " + error);
            }
        });
    }

    //ê³µê³µë°ì´í„° api XMLì„ JSONìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function xmlToJson(xml) {
        var obj = {};
        if (xml.nodeType == 1) { // element
            if (xml.attributes.length > 0) {
                obj["@attributes"] = {};
                for (var j = 0; j < xml.attributes.length; j++) {
                    var attribute = xml.attributes.item(j);
                    obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
                }
            }
        } else if (xml.nodeType == 3) { // text
            obj = xml.nodeValue;
        }

        if (xml.hasChildNodes()) {
            for (var i = 0; i < xml.childNodes.length; i++) {
                var item = xml.childNodes.item(i);
                var nodeName = item.nodeName;
                if (typeof obj[nodeName] == "undefined") {
                    obj[nodeName] = xmlToJson(item);
                } else {
                    if (typeof obj[nodeName].push == "undefined") {
                        var old = obj[nodeName];
                        obj[nodeName] = [];
                        obj[nodeName].push(old);
                    }
                    obj[nodeName].push(xmlToJson(item));
                }
            }
        }
        return obj;
    }
</script>
</div>
</body>
</html>
